name: schedule-update-and-notify

on:
  workflow_dispatch:
  schedule:
    # æ¯åŠå°æ—¶æ‰§è¡Œä¸€æ¬¡ (åœ¨æ¯å°æ—¶çš„ç¬¬ 0 åˆ†é’Ÿå’Œç¬¬ 30 åˆ†é’Ÿ)
    - cron: "0,30 * * * *"

jobs:
  build-and-notify:
    runs-on: ubuntu-latest
    
    # æˆäºˆå·¥ä½œæµå¯¹ä»“åº“å†…å®¹çš„å†™å…¥æƒé™ï¼Œä»¥å…è®¸ git push
    permissions:
      contents: write

    env:
      TZ: Asia/Shanghai

    steps:
      # æ­¥éª¤ 1: å…‹éš†ä»“åº“
      - name: Clone repo
        uses: actions/checkout@v4
        with:
          # å¿…é¡»è·å–å®Œæ•´çš„æäº¤å†å²ï¼Œæ‰èƒ½åœ¨åç»­æ­¥éª¤ä¸­è¯»å–ä¸Šä¸€ä¸ªcommitçš„æ–‡ä»¶
          fetch-depth: 0

      # æ­¥éª¤ 2: é…ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: 'pip'

      # æ­¥éª¤ 3: å®‰è£…Pythonä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # æ­¥éª¤ 4: é…ç½®Gitç”¨æˆ·ä¿¡æ¯
      - name: Config git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git pull --rebase

      # æ­¥éª¤ 5: è¿è¡ŒPythonè„šæœ¬ä»¥ç”Ÿæˆæˆ–æ›´æ–°ç‹¬ç«‹çš„JSONæ–‡ä»¶
      - name: Run python script
        run: python -u main.py
        env:
          ENABLE_DEBUG_PRINT: true

      # æ­¥éª¤ 6: æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŠ¨ï¼Œå¹¶è®¾ç½®ä¸€ä¸ªè¾“å‡ºå˜é‡
      - name: Check for file changes
        id: git-check
        run: |
          if ! git diff-index --quiet HEAD; then
            echo "Changes detected."
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No changes to commit."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤ 7: æäº¤å¹¶æ¨é€å˜æ›´
      - name: Commit and push changes
        if: steps.git-check.outputs.has_changes == 'true'
        run: |
          git add .
          git commit -m "update by github action"
          git push -u origin main

      # æ­¥éª¤ 8: âœ¨ ä»ç‹¬ç«‹çš„JSONæ–‡ä»¶æ„å»ºå¹¶å‘é€ç¾åŒ–åçš„é£ä¹¦é€šçŸ¥ âœ¨
      - name: Build and Send Notifications from JSON Files
        if: steps.git-check.outputs.has_changes == 'true'
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          FEISHU_WEBHOOK_URL_TEST: ${{ secrets.FEISHU_WEBHOOK_URL_TEST }}
        run: |
          # 1. å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºå°† JSON æ•°ç»„å®‰å…¨åœ°è½¬æ¢ä¸ºå¸¦åºå·çš„ Markdown åˆ—è¡¨
          json_to_markdown_list() {
              # ä½¿ç”¨ jq:
              # -s (--slurp) è¯»å–æ‰€æœ‰è¾“å…¥å½¢æˆä¸€ä¸ªæ•°ç»„
              # -r (--raw-output) è¾“å‡ºåŸå§‹æ–‡æœ¬ï¼Œè€Œä¸æ˜¯å¸¦å¼•å·çš„JSONå­—ç¬¦ä¸²
              # [0] | if . then ... else "" end: å®‰å…¨åœ°å¤„ç†ç©ºè¾“å…¥
              # to_entries | .[]: å°†æ•°ç»„è½¬æ¢ä¸º [key, value] å¯¹è±¡å¹¶éå†
              # "\(.key + 1). [\(.value.title)](\(.value.url))": æ ¼å¼åŒ–ä¸º Markdown
              jq -sr '[.[] | to_entries | .[] | "\(.key + 1). [\(.value.title)](\(.value.url))"] | join("\n")'
          }

          # 2. ä» git HEAD (æœ€æ–°æäº¤) ä¸­ç›´æ¥è¯»å–å½“å¤©çš„ JSON æ–‡ä»¶å†…å®¹
          #    "2>/dev/null || echo '[]'" æ˜¯ä¸€ä¸ªå®‰å…¨æªæ–½ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼ˆä¾‹å¦‚è„šæœ¬å¤±è´¥ï¼‰ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºçš„JSONæ•°ç»„
          CURRENT_DATE=$(date +%Y-%m-%d)
          KR_JSON=$(git show HEAD:./raw/36kr/$CURRENT_DATE.json 2>/dev/null || echo "[]")
          JUEJIN_JSON=$(git show HEAD:./raw/juejin/$CURRENT_DATE.json 2>/dev/null || echo "[]")
          GITHUB_JSON=$(git show HEAD:./raw/github/$CURRENT_DATE.json 2>/dev/null || echo "[]")
          SSPAI_JSON=$(git show HEAD:./raw/sspai/$CURRENT_DATE.json 2>/dev/null || echo "[]")
          UPDATE_TIME=$(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')

          # 3. å°†æ¯ä¸ªå¹³å°çš„ JSON è½¬æ¢ä¸ºæ ¼å¼æ­£ç¡®çš„ Markdown åˆ—è¡¨
          KR_MD=$(echo "$KR_JSON" | json_to_markdown_list)
          JUEJIN_MD=$(echo "$JUEJIN_JSON" | json_to_markdown_list)
          GITHUB_MD=$(echo "$GITHUB_JSON" | json_to_markdown_list)
          SSPAI_MD=$(echo "$SSPAI_JSON" | json_to_markdown_list)
          
          # 4. åœ¨ Shell ä¸­é€æ­¥ã€å®‰å…¨åœ°æ„å»º "elements" JSON æ•°ç»„
          ELEMENTS_JSON="[$(jq -n --arg time "$UPDATE_TIME" '{"tag": "div", "text": {"tag": "lark_md", "content": ("**æ›´æ–°æ—¶é—´:** " + $time)}}')]"
          
          # æ·»åŠ ç½²åä¿¡æ¯
          SIGNATURE=$(jq -n '{"tag": "div", "text": {"tag": "lark_md", "content": "*Created by äºˆæˆBot*"}}')
          ELEMENTS_JSON=$(echo "$ELEMENTS_JSON" | jq --argjson signature "$SIGNATURE" '. + [$signature]')

          if [ -n "$KR_MD" ]; then
            SECTION=$(jq -n --arg content "$KR_MD" '[{"tag": "hr"}, {"tag": "div", "text": {"tag": "lark_md", "content": "**36æ°ª | çƒ­æ¦œ**"}}, {"tag": "div", "text": {"tag": "lark_md", "content": $content}}]')
            ELEMENTS_JSON=$(echo "$ELEMENTS_JSON" | jq --argjson section "$SECTION" '. + $section')
          fi

          if [ -n "$JUEJIN_MD" ]; then
            SECTION=$(jq -n --arg content "$JUEJIN_MD" '[{"tag": "hr"}, {"tag": "div", "text": {"tag": "lark_md", "content": "**æ˜é‡‘ | çƒ­æ¦œ**"}}, {"tag": "div", "text": {"tag": "lark_md", "content": $content}}]')
            ELEMENTS_JSON=$(echo "$ELEMENTS_JSON" | jq --argjson section "$SECTION" '. + $section')
          fi

          if [ -n "$GITHUB_MD" ]; then
            SECTION=$(jq -n --arg content "$GITHUB_MD" '[{"tag": "hr"}, {"tag": "div", "text": {"tag": "lark_md", "content": "**GitHub | Trending**"}}, {"tag": "div", "text": {"tag": "lark_md", "content": $content}}]')
            ELEMENTS_JSON=$(echo "$ELEMENTS_JSON" | jq --argjson section "$SECTION" '. + $section')
          fi

          if [ -n "$SSPAI_MD" ]; then
            SECTION=$(jq -n --arg content "$SSPAI_MD" '[{"tag": "hr"}, {"tag": "div", "text": {"tag": "lark_md", "content": "**å°‘æ•°æ´¾ | çƒ­æ¦œ**"}}, {"tag": "div", "text": {"tag": "lark_md", "content": $content}}]')
            ELEMENTS_JSON=$(echo "$ELEMENTS_JSON" | jq --argjson section "$SECTION" '. + $section')
          fi

          BUTTONS_JSON='[{"tag": "hr"}, {"tag": "action", "actions": [{"tag": "button", "text": {"tag": "plain_text", "content": "å‰å¾€ 36æ°ª"}, "type": "default", "url": "https://36kr.com/"}, {"tag": "button", "text": {"tag": "plain_text", "content": "å‰å¾€ æ˜é‡‘"}, "type": "default", "url": "https://juejin.cn/hot"}, {"tag": "button", "text": {"tag": "plain_text", "content": "å‰å¾€ GitHub"}, "type": "default", "url": "https://github.com/trending"}, {"tag": "button", "text": {"tag": "plain_text", "content": "å‰å¾€ å°‘æ•°æ´¾"}, "type": "default", "url": "https://sspai.com/"}]}]'
          ELEMENTS_JSON=$(echo "$ELEMENTS_JSON" | jq --argjson buttons "$BUTTONS_JSON" '. + $buttons')

          # 5. ä½¿ç”¨æœ€ç»ˆçš„æ¨¡æ¿ï¼Œå°†æ„å»ºå¥½çš„ elements æ•°ç»„å®‰å…¨åœ°æ³¨å…¥
          JSON_PAYLOAD=$(jq -n --argjson elements "$ELEMENTS_JSON" \
          '{
            "msg_type": "interactive",
            "card": {
              "config": { "wide_screen_mode": true },
              "header": { "title": { "tag": "plain_text", "content": "ğŸ“° æ¯æ—¥çƒ­æ¦œç®€æŠ¥" }, "template": "blue" },
              "elements": $elements
            }
          }')

          # 6. å¾ªç¯éå†æ‰€æœ‰ webhook URL å¹¶å‘é€é€šçŸ¥
          for url in "$FEISHU_WEBHOOK_URL" "$FEISHU_WEBHOOK_URL_TEST"; do
            if [ -n "$url" ]; then
              echo "Sending notification to a webhook..."
              curl -X POST -H "Content-Type: application/json" -d "$JSON_PAYLOAD" "$url"
            else
              echo "Skipping an empty webhook URL."
            fi
          done
