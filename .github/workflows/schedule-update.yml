name: schedule-update-and-notify

on:
  workflow_dispatch:
  schedule:
    # æ¯åŠå°æ—¶æ‰§è¡Œä¸€æ¬¡ (åœ¨æ¯å°æ—¶çš„ç¬¬ 0 åˆ†é’Ÿå’Œç¬¬ 30 åˆ†é’Ÿ)
    - cron: "0,30 * * * *"

jobs:
  build-and-notify:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    env:
      TZ: Asia/Shanghai

    steps:
      # æ­¥éª¤ 1-5: ä¸ä¹‹å‰ç‰ˆæœ¬å®Œå…¨ç›¸åŒï¼Œè´Ÿè´£å‡†å¤‡ç¯å¢ƒå’Œè¿è¡Œè„šæœ¬
      - name: Clone repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Config git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git pull --rebase
      - name: Run python script
        run: python -u main.py
        env:
          ENABLE_DEBUG_PRINT: true

      # æ­¥éª¤ 6-7: ä¸ä¹‹å‰ç‰ˆæœ¬å®Œå…¨ç›¸åŒï¼Œè´Ÿè´£æ£€æŸ¥å˜åŠ¨å¹¶æäº¤
      - name: Check for file changes
        id: git-check
        run: |
          if ! git diff-index --quiet HEAD; then
            echo "Changes detected."
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No changes to commit."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      - name: Commit and push changes
        if: steps.git-check.outputs.has_changes == 'true'
        run: |
          git add .
          git commit -m "update by github action"
          git push -u origin main

      # æ­¥éª¤ 8: âœ¨ å‘é€å¸¦è·³è½¬æŒ‰é’®çš„â€œçƒ­æ¦œç®€æŠ¥â€é£ä¹¦é€šçŸ¥ âœ¨
      - name: Send Interactive News Digest to Feishu
        if: steps.git-check.outputs.has_changes == 'true'
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          # 1. è·å–æœ€æ–°æäº¤çš„æ–°å¢å†…å®¹ï¼Œå¹¶è¿›è¡Œæ¸…ç†
          CLEAN_CONTENT=$(git diff HEAD~1 HEAD | grep '^\+' | grep -v '+++' | grep -v '<!--' | grep -v '^$+' | sed 's/^+//')

          # 2. æŒ‰æ–°çš„å¹³å°æ¥æºæå–æ–°é—»
          KR_NEWS=$(echo "$CLEAN_CONTENT" | grep '36kr.com' || true)
          JUEJIN_NEWS=$(echo "$CLEAN_CONTENT" | grep 'juejin.cn' || true)
          GITHUB_NEWS=$(echo "$CLEAN_CONTENT" | grep 'github.com' || true)

          # 3. è·å–å½“å‰æ—¶é—´
          UPDATE_TIME=$(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')

          # 4. ä½¿ç”¨ jq åŠ¨æ€æ„å»ºå¸¦æŒ‰é’®çš„æ¶ˆæ¯å¡ç‰‡
          JSON_PAYLOAD=$(jq -n \
            --arg time "$UPDATE_TIME" \
            --arg kr "$KR_NEWS" \
            --arg juejin "$JUEJIN_NEWS" \
            --arg github "$GITHUB_NEWS" \
            '
            # å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºç”Ÿæˆå•ä¸ªæ¥æºçš„æ–°é—»æ¨¡å—
            def section(title; content):
              if ($content | length > 0) then
                [
                  {"tag": "hr"},
                  {"tag": "div", "text": {"tag": "lark_md", "content": "**" + title + "**"}},
                  {"tag": "div", "text": {"tag": "lark_md", "content": $content}}
                ]
              else
                []
              end;

            {
              "msg_type": "interactive",
              "card": {
                "config": { "wide_screen_mode": true },
                "header": {
                  "title": { "tag": "plain_text", "content": "ğŸ“° æ¯æ—¥çƒ­æ¦œç®€æŠ¥" },
                  "template": "blue"
                },
                "elements": [
                  {"tag": "div", "text": {"tag": "lark_md", "content": ("**æ›´æ–°æ—¶é—´:** " + $time)}}
                ] +
                section("36æ°ª | çƒ­æ¦œ"; $kr) +
                section("æ˜é‡‘ | çƒ­æ¦œ"; $juejin) +
                section("GitHub | Trending"; $github) +
                [
                  {"tag": "hr"},
                  {
                    "tag": "action",
                    "actions": [
                      {
                        "tag": "button",
                        "text": { "tag": "plain_text", "content": "å‰å¾€ 36æ°ª" },
                        "type": "default",
                        "url": "https://36kr.com/"
                      },
                      {
                        "tag": "button",
                        "text": { "tag": "plain_text", "content": "å‰å¾€ æ˜é‡‘" },
                        "type": "default",
                        "url": "https://juejin.cn/hot"
                      },
                      {
                        "tag": "button",
                        "text": { "tag": "plain_text", "content": "å‰å¾€ GitHub" },
                        "type": "default",
                        "url": "https://github.com/trending"
                      }
                    ]
                  }
                ]
              }
            }
            ')

          # 5. å‘é€æœ€ç»ˆæ„å»ºå¥½çš„ JSON payload
          curl -X POST -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "$FEISHU_WEBHOOK_URL"
